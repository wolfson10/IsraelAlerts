<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Israel Threat Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
          xintegrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
            xintegrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
            crossorigin=""></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Prevent body scroll */
        }
        #map {
            height: 100vh;
            width: 100%;
        }
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
        }
        /* Styles for the modals */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 2000; /* Sit on top of everything */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; /* Enable scroll if needed */
            background-color: rgb(0,0,0); /* Fallback color */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }
        .modal-content {
            margin: 5% auto; /* 5% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 90%; /* Make width responsive */
            max-width: 600px;
            border-radius: 10px;
            max-height: 90vh; /* Ensure it doesn't overflow vertical screen */
            display: flex;
            flex-direction: column;
        }
        .modal-body {
            overflow-y: auto;
        }
        .close-button {
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        /* Dark mode styles */
        .dark body {
            background-color: #111827; /* gray-900 */
            color: #e5e7eb; /* gray-200 */
        }
        .dark .bg-white {
             background-color: #1f2937; /* gray-800 */
        }
        .dark .bg-gray-100 {
             background-color: #4b5563; /* gray-600 */
        }
        .dark .text-gray-800, .dark .text-gray-700, .dark .text-gray-500, .dark .text-gray-400, .dark label, .dark span, .dark h1, .dark h2, .dark h3, .dark h4, .dark p {
            color: #e5e7eb; /* gray-200 */
        }
        .dark .border-b, .dark .border-t {
            border-color: #4b5563; /* gray-600 */
        }
        .dark .modal-content {
            background-color: #374151; /* gray-700 */
            border-color: #4b5563;
        }
        .dark .close-button {
            color: #9ca3af;
        }
         .dark .close-button:hover {
            color: #e5e7eb;
        }
        .dark .bg-gray-50 {
            background-color: #374151; /* gray-700 */
        }
        .dark select, .dark input[type=text] {
            background-color: #4b5563;
            color: #e5e7eb;
        }
        .dark .leaflet-popup-content-wrapper {
            background-color: #374151;
            color: #e5e7eb;
        }
        .dark .leaflet-popup-tip {
            background-color: #374151;
        }
        .dark #menu-button {
            background-color: #374151;
            color: #e5e7eb;
        }
        /* Specific dark mode styles for the error message */
        .error-message-container {
            background-color: #fee2e2; /* red-100 */
            color: #b91c1c; /* red-700 */
        }
        .dark .error-message-container {
            background-color: #7f1d1d; /* red-900 */
            color: #fca5a5; /* red-300 */
        }
        /* Specific dark mode styles for the upload button */
        .upload-button {
            background-color: #e0f2f7; /* light blue-100 */
            color: #0c4a6e; /* dark blue-800 */
        }
        .upload-button:hover {
            background-color: #bae6fd; /* light blue-200 */
        }
        .dark .upload-button {
            background-color: #1e3a8a; /* blue-900 */
            color: #bfdbfe; /* blue-200 */
        }
        .dark .upload-button:hover {
            background-color: #172554; /* blue-950 */
        }

        /* New: Sidebar specific styles */
        #sidebar {
            background-color: #f8fafc; /* A very light gray-50 for light mode */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
            border-right: 1px solid #e2e8f0; /* subtle gray-200 border */
            /* Light mode background image */
            background-image: url("https://wallpapersok.com/images/thumbnail/japanese-anime-city-theme-background-6nu23nc8hsb7idk5.jpg");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: relative; /* Needed for pseudo-element overlay */
            overflow: hidden; /* Ensures image doesn't bleed outside */
            
            /* Mobile adjustments for sidebar */
            position: fixed; /* Make it fixed for overlay behavior on mobile */
            top: 0;
            left: 0;
            height: 100%;
            /* The transform classes are now handled directly in the HTML with md: prefixes */
            /* width: 100%; */ /* This might be too wide on very small screens, better to use max-w-sm in HTML */
            /* max-width: 320px; /* Optional: set a max-width for the sidebar on small screens if desired */
        }
        .dark #sidebar {
            background-color: #283141; /* Darker blue-gray for dark mode as base */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2); /* darker shadow */
            border-right: 1px solid #4a5568; /* darker subtle border */
            /* Dark mode image background */
            background-image: url("https://images.steamusercontent.com/ugc/1653349153247030929/9AB721132ECFE6E95BB40BD203A5F462BC4A481C/?imw=512&&ima=fit&impolicy=Letterbox&imcolor=%23000000&letterbox=false");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: relative; /* Needed for pseudo-element overlay */
            overflow: hidden; /* Ensures image doesn't bleed outside */
        }

        /* Overlay for sidebar background images */
        #sidebar::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.3); /* Light overlay for bright mode */
            z-index: -1; /* Place behind content */
        }
        .dark #sidebar::before {
            background-color: rgba(0, 0, 0, 0.5); /* Darker overlay for dark mode */
        }

        .sidebar-header {
            background-image: linear-gradient(to right, #60a5fa, #3b82f6); /* blue-400 to blue-500 */
            color: white;
            padding: 1.5rem; /* More padding */
            border-bottom: none; /* Remove default border */
            border-radius: 0.5rem 0.5rem 0 0; /* Rounded top corners */
            position: relative; /* Ensure it's above the overlay */
            z-index: 1;
        }
        .dark .sidebar-header {
            background-image: linear-gradient(to right, #1e3a8a, #1d4ed8); /* blue-900 to blue-800 */
        }

        .sidebar-section {
            border-color: #e5e7eb; /* gray-200 */
            padding: 1rem;
            position: relative; /* Ensure content is above the overlay */
            z-index: 1;
        }
        .dark .sidebar-section {
            border-color: #4a5568; /* darker gray for dark mode */
        }

        .sidebar-button {
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 600; /* semi-bold */
            position: relative; /* Ensure button is above overlay */
            z-index: 1;
        }
        .sidebar-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
        }
        .dark .sidebar-button {
            box-shadow: 0 4px 6px -1px rgba(255, 255, 255, 0.05), 0 2px 4px -1px rgba(255, 255, 255, 0.03);
        }
        .dark .sidebar-button:hover {
            box-shadow: 0 10px 15px -3px rgba(255, 255, 255, 0.1), 0 4px 6px -2px rgba(255, 255, 255, 0.05);
        }

        .alert-list-item {
            background-color: #f3f4f6; /* gray-100 */
            border-radius: 0.5rem; /* rounded-md */
            transition: background-color 0.2s ease-in-out;
            position: relative; /* Ensure item is above overlay */
            z-index: 1;
        }
        .alert-list-item:hover {
            background-color: #e5e7eb; /* gray-200 */
        }
        .dark .alert-list-item {
            background-color: #374151; /* gray-700 */
        }
        .dark .alert-list-item:hover {
            background-color: #4a5568; /* darker gray for dark mode */
        }
    </style>
</head>
<body class="bg-gray-100">

<div class="relative h-screen w-screen flex">
    <div id="sidebar" class="absolute w-full max-w-sm z-30 h-full flex flex-col transform -translate-x-full transition-transform duration-300 ease-in-out md:relative md:w-1/3 lg:w-1/4 md:translate-x-0">
        <div class="rounded-t-lg sidebar-header flex-shrink-0">
            <h1 class="text-2xl font-bold" data-i18n="appTitle">Israel Real-Time Alerts</h1>
            <p class="text-sm opacity-90" data-i18n="appSubtitle">Live threat monitoring</p>
        </div>

        <div class="border-b sidebar-section flex-shrink-0">
            <button id="settings-button" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 sidebar-button" data-i18n="settingsButton">Settings</button>
        </div>
        
        <div class="border-b sidebar-section flex-shrink-0">
            <h3 class="font-semibold text-gray-700 dark:text-gray-200" data-i18n="threatLegendTitle">Threat Legend</h3>
            <div id="threat-legend" class="mt-2 space-y-1 text-sm">
                </div>
        </div>

        <div class="border-b sidebar-section flex-shrink-0">
            <button id="test-alert-button" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-4 sidebar-button" data-i18n="testAlertButton">Test Alert</button>
        </div>

        <div class="border-b sidebar-section flex-shrink-0">
            <h4 class="font-semibold mb-2 text-gray-700 dark:text-gray-200" data-i18n="listManagementTitle">List Management</h4>
            <div class="flex space-x-2 mt-2">
                <button id="delete-selected-alerts" class="w-1/2 bg-orange-500 hover:bg-orange-600 text-white py-1 px-2 text-sm sidebar-button" data-i18n="deleteSelectedButton">Delete Selected</button>
                <button id="clear-all-alerts" class="w-1/2 bg-red-500 hover:bg-red-600 text-white py-1 px-2 text-sm sidebar-button" data-i18n="clearAllButton">Clear All</button>
            </div>
        </div>

        <div id="alert-list" class="p-4 space-y-4 flex-grow overflow-y-auto">
            <div class="text-center text-gray-500 py-8" data-i18n="noAlertsMessage">
                <p>No alerts yet. Waiting for data...</p>
            </div>
        </div>

        <div class="border-t sidebar-section text-xs text-gray-400 flex-shrink-0" data-i18n="dataSourceDisclaimer">
            Data sourced from the Home Front Command. This is not an official government service.
        </div>
    </div>

    <div class="flex-grow h-full">
        <div id="map" class="h-full z-10"></div>
    </div>
</div>

<button id="menu-button" class="absolute top-4 right-4 z-40 bg-white p-2 rounded-full shadow-lg flex items-center justify-center md:hidden">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-800" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
    </svg>
</button>
<div id="map-overlay" class="absolute inset-0 bg-black bg-opacity-50 z-20 transition-opacity duration-300 hidden md:hidden"></div>


<div id="settings-modal" class="modal">
    <div class="modal-content bg-white">
        <div class="flex-shrink-0">
            <span class="close-button" id="close-settings">&times;</span>
            <h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-gray-200" data-i18n="settingsModalTitle">Settings</h2>
        </div>
        
        <div class="modal-body flex-grow">
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-2 text-gray-700 dark:text-gray-200" data-i18n="languageTitle">Language</h3>
                <select id="language-select" class="w-full p-2 border rounded-md bg-white dark:bg-gray-700 dark:text-gray-200">
                    <option value="en">English</option>
                    <option value="he">עברית</option>
                    <option value="ru">Русский</option>
                </select>
            </div>

            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-2 text-gray-700 dark:text-gray-200" data-i18n="areasOfInterestTitle">Areas of Interest</h3>
                <div id="area-selection-container" class="relative text-gray-800">
                    <button id="area-select-button" class="w-full p-2 border rounded-md text-left dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200">
                        <span id="area-select-summary" data-i18n="allAreasSelected">All areas selected</span>
                    </button>
                    <div id="area-dropdown" class="hidden absolute w-full bg-white border mt-1 rounded-md shadow-lg max-h-60 z-10 flex flex-col dark:bg-gray-800 dark:border-gray-600">
                        <input type="text" id="area-search" placeholder="Search areas..." class="sticky top-0 w-full p-2 border-b dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200" data-i18n-placeholder="searchAreasPlaceholder">
                        <div id="area-list-dropdown" class="p-2 overflow-y-auto">
                            </div>
                    </div>
                </div>
            </div>

            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-2 text-gray-700 dark:text-gray-200" data-i18n="alertSoundsTitle">Alert Sounds</h3>
                <div id="sound-settings-container" class="space-y-4 text-gray-800">
                    </div>
            </div>
            
            <div>
                 <h3 class="text-lg font-semibold mb-2 text-gray-700 dark:text-gray-200" data-i18n="themeTitle">Theme</h3>
                 <div class="flex items-center justify-between text-gray-800 dark:text-gray-200">
                    <span data-i18n="darkModeLabel">Dark Mode</span>
                     <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" id="theme-toggle" class="sr-only peer">
                      <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                    </label>
                 </div>
            </div>
        </div>
        <div class="mt-6 flex space-x-2 flex-shrink-0">
            <button id="save-settings" class="w-full bg-green-500 hover:bg-green-600 text-white py-2 px-4 sidebar-button" data-i18n="saveButton">Save</button>
        </div>
    </div>
</div>

<audio id="alert-sound" src=""></audio>

<script>
    // --- INITIALIZATION ---
    console.log("Script starting..."); // Added for debugging
    let currentMapLayer = null;
    const lightMapUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
    const darkMapUrl = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
    const map = L.map('map').setView([31.5, 34.75], 8);

    const alertList = document.getElementById('alert-list');
    let activePolygons = {};
    let alertLog = [];
    let selectedAreas = [];
    let alertSounds = {
        rockets: 'sound1',
        earthquake: 'sound1',
        infiltration: 'sound1',
        aircraft_intrusion: 'sound1',
        hazardous_materials: 'sound1',
        tsunami: 'sound1'
    };
    // Moved threatLabels here to be dynamic with language
    let threatLabels = {}; 

    const cityData = {
        "Acre": { lat: 32.929, lon: 35.078, time: 30, bounds: null }, "Afula": { lat: 32.612, lon: 35.293, time: 90, bounds: null }, "Arad": { lat: 31.259, lon: 35.213, time: 90, bounds: null }, "Ashdod": { lat: 31.791, lon: 34.649, time: 45, bounds: null }, "Ashkelon": { lat: 31.6693, lon: 34.5715, time: 30, bounds: [[31.69, 34.55], [31.69, 34.60], [31.64, 34.60], [31.64, 34.55]] }, "Baqa al-Gharbiyye": { lat: 32.417, lon: 35.038, time: 90, bounds: null }, "Bat Yam": { lat: 32.017, lon: 34.750, time: 90, bounds: null }, "Be'er Sheva": { lat: 31.2530, lon: 34.7915, time: 60, bounds: [[31.27, 34.77], [31.27, 34.82], [31.23, 34.82], [31.23, 34.77]] }, "Beit She'an": { lat: 32.498, lon: 35.498, time: 60, bounds: null }, "Beit Shemesh": { lat: 31.751, lon: 34.988, time: 90, bounds: null }, "Bnei Brak": { lat: 32.086, lon: 34.829, time: 90, bounds: null }, "Dimona": { lat: 31.069, lon: 35.033, time: 90, bounds: null }, "Eilat": { lat: 29.558, lon: 34.948, time: 180, bounds: null }, "El'ad": { lat: 32.051, lon: 34.952, time: 90, bounds: null }, "Givatayim": { lat: 32.072, lon: 34.811, time: 90, bounds: null }, "Hadera": { lat: 32.434, lon: 34.919, time: 90, bounds: null }, "Haifa": { lat: 32.7940, lon: 34.9896, time: 60, bounds: [[32.83, 34.97], [32.83, 35.03], [32.77, 35.03], [32.77, 34.97]] }, "Herzliya": { lat: 32.165, lon: 34.847, time: 90, bounds: null }, "Hod HaSharon": { lat: 32.153, lon: 34.891, time: 90, bounds: null }, "Holon": { lat: 32.011, lon: 34.778, time: 90, bounds: null }, "Jerusalem": { lat: 31.7683, lon: 35.2137, time: 90, bounds: [[31.80, 35.18], [31.80, 35.24], [31.74, 35.24], [31.74, 35.18]] }, "Karmiel": { lat: 32.915, lon: 35.294, time: 30, bounds: null }, "Kfar Saba": { lat: 32.174, lon: 34.908, time: 90, bounds: null }, "Kiryat Ata": { lat: 32.812, lon: 35.111, time: 60, bounds: null }, "Kiryat Bialik": { lat: 32.839, lon: 35.088, time: 60, bounds: null }, "Kiryat Gat": { lat: 31.610, lon: 34.764, time: 45, bounds: null }, "Kiryat Malakhi": { lat: 31.734, lon: 34.747, time: 45, bounds: null }, "Kiryat Motzkin": { lat: 32.836, lon: 35.077, time: 60, bounds: null }, "Kiryat Ono": { lat: 32.062, lon: 34.856, time: 90, bounds: null }, "Kiryat Shmona": { lat: 33.208, lon: 35.570, time: 10, bounds: null }, "Kiryat Yam": { lat: 32.852, lon: 35.069, time: 60, bounds: null }, "Lod": { lat: 31.950, lon: 34.891, time: 90, bounds: null }, "Ma'alot-Tarshiha": { lat: 33.016, lon: 35.275, time: 30, bounds: null }, "Migdal HaEmek": { lat: 32.673, lon: 35.241, time: 60, bounds: null }, "Modi'in-Maccabim-Re'ut": { lat: 31.904, lon: 35.008, time: 90, bounds: null }, "Nahariya": { lat: 33.007, lon: 35.093, time: 30, bounds: null }, "Nazareth": { lat: 32.702, lon: 35.298, time: 60, bounds: null }, "Nesher": { lat: 32.766, lon: 35.051, time: 60, bounds: null }, "Ness Ziona": { lat: 31.928, lon: 34.796, time: 90, bounds: null }, "Netanya": { lat: 32.321, lon: 34.857, time: 90, bounds: null }, "Netivot": { lat: 31.420, lon: 34.590, time: 30, bounds: null }, "Ofakim": { lat: 31.313, lon: 34.620, time: 45, bounds: null }, "Or Akiva": { lat: 32.511, lon: 34.922, time: 90, bounds: null }, "Or Yehuda": { lat: 32.029, lon: 34.855, time: 90, bounds: null }, "Petah Tikva": { lat: 32.088, lon: 34.887, time: 90, bounds: null }, "Qalansawe": { lat: 32.289, lon: 34.989, time: 90, bounds: null }, "Ra'anana": { lat: 32.184, lon: 34.872, time: 90, bounds: null }, "Rahat": { lat: 31.396, lon: 34.755, time: 45, bounds: null }, "Ramat Gan": { lat: 32.083, lon: 34.825, time: 90, bounds: null }, "Ramat HaSharon": { lat: 32.144, lon: 34.839, time: 90, bounds: null }, "Ramla": { lat: 31.927, lon: 34.869, time: 90, bounds: null }, "Rehovot": { lat: 31.892, lon: 34.808, time: 90, bounds: null }, "Rishon LeZion": { lat: 31.972, lon: 34.793, time: 90, bounds: null }, "Rosh HaAyin": { lat: 32.096, lon: 34.942, time: 90, bounds: null }, "Safed": { lat: 32.965, lon: 35.498, time: 30, bounds: null }, "Sakhnin": { lat: 32.860, lon: 35.297, time: 30, bounds: null }, "Sderot": { lat: 31.525, lon: 34.5942, time: 15, bounds: [[31.535, 34.58], [31.535, 34.61], [31.515, 34.61], [31.515, 34.58]] }, "Shfaram": { lat: 32.805, lon: 35.171, time: 60, bounds: null }, "Tamra": { lat: 32.853, lon: 35.201, time: 60, bounds: null }, "Tayibe": { lat: 32.266, lon: 35.009, time: 90, bounds: null }, "Tel Aviv": { lat: 32.0853, lon: 34.7818, time: 90, bounds: [[32.11, 34.76], [32.11, 34.81], [32.05, 34.81], [32.05, 34.76]] }, "Tiberias": { lat: 32.792, lon: 35.531, time: 60, bounds: null },
        "Tira": { lat: 32.233, lon: 34.950, time: 90, bounds: null }, "Tirat Carmel": { lat: 32.763, lon: 34.969, time: 60, bounds: null }, "Umm al-Fahm": { lat: 32.518, lon: 35.153, time: 90, bounds: null }, "Yavne": { lat: 31.879, lon: 34.739, time: 90, bounds: null }, "Yehud-Monosson": { lat: 32.033, lon: 34.890, time: 90, bounds: null }, "Yokneam Illit": { lat: 32.659, lon: 35.109, time: 60, bounds: null },
    };

    const threatColors = {
        rockets: '#cc0000',
        earthquake: '#994400',
        infiltration: '#ff8f00',
        aircraft_intrusion: '#8b5eeb',
        hazardous_materials: '#dc950e',
        tsunami: '#0095df',
        default: '#4a4a4a'
    };

    const soundFiles = {
        sound1: 'https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg',
        sound2: 'https://actions.google.com/sounds/v1/alarms/bugle_tune.ogg',
        sound3: 'https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg'
    };
    let customSounds = {};

    // Reference to the audio element for global control
    const audioPlayer = document.getElementById('alert-sound');
    let customSoundTimeoutId = null; // Global variable for sound trimming timeout

    // --- TRANSLATIONS ---
    const translations = {
        en: {
            appTitle: 'Israel Real-Time Alerts',
            appSubtitle: 'Live threat monitoring',
            settingsButton: 'Settings',
            threatLegendTitle: 'Threat Legend',
            testAlertButton: 'Test Alert',
            listManagementTitle: 'List Management',
            deleteSelectedButton: 'Delete Selected',
            clearAllButton: 'Clear All',
            noAlertsMessage: 'No alerts yet. Waiting for data...',
            dataSourceDisclaimer: 'Data sourced from the Home Front Command. This is not an official government service.',
            settingsModalTitle: 'Settings',
            languageTitle: 'Language',
            areasOfInterestTitle: 'Areas of Interest',
            allAreasSelected: 'All areas selected',
            noAreasSelected: 'No areas selected',
            areasSelected: '{count} areas selected',
            searchAreasPlaceholder: 'Search areas...',
            alertSoundsTitle: 'Alert Sounds',
            alarm1: 'Alarm 1',
            alarm2: 'Alarm 2',
            alarm3: 'Alarm 3',
            custom: 'Custom',
            uploadButton: 'Upload',
            themeTitle: 'Theme',
            darkModeLabel: 'Dark Mode',
            saveButton: 'Save',
            validAudioFile: 'Please select a valid audio file.',
            soundUploadedSuccess: 'Sound uploaded successfully. Playback will be limited to 15 seconds.',
            noAlertsSelectedForDeletion: 'No alerts selected for deletion.',
            errorFetchingAlerts: 'Error: Could not fetch alerts.',
            networkIssuesOrApiRestrictions: 'This may be due to network issues or API restrictions.',
            rockets: 'Rocket Fire',
            earthquake: 'Earthquake',
            infiltration: 'Terrorist Infiltration',
            aircraft_intrusion: 'Hostile Aircraft Intrusion',
            hazardous_materials: 'Hazardous Materials',
            tsunami: 'Tsunami',
        },
        he: {
            appTitle: 'התראות אמת בישראל',
            appSubtitle: 'ניטור איומים בזמן אמת',
            settingsButton: 'הגדרות',
            threatLegendTitle: 'מקרא איומים',
            testAlertButton: 'בדיקת התראה',
            listManagementTitle: 'ניהול רשימה',
            deleteSelectedButton: 'מחק נבחרים',
            clearAllButton: 'נקה הכל',
            noAlertsMessage: 'אין התראות עדיין. ממתין לנתונים...',
            dataSourceDisclaimer: 'הנתונים נלקחו מפיקוד העורף. זהו אינו שירות ממשלתי רשמי.',
            settingsModalTitle: 'הגדרות',
            languageTitle: 'שפה',
            areasOfInterestTitle: 'אזורי עניין',
            allAreasSelected: 'כל האזורים נבחרו',
            noAreasSelected: 'לא נבחרו אזורים',
            areasSelected: '{count} אזורים נבחרו',
            searchAreasPlaceholder: 'חפש אזורים...',
            alertSoundsTitle: 'צלילי התראה',
            alarm1: 'אזעקה 1',
            alarm2: 'אזעקה 2',
            alarm3: 'אזעקה 3',
            custom: 'מותאם אישית',
            uploadButton: 'העלה',
            themeTitle: 'עיצוב',
            darkModeLabel: 'מצב כהה',
            saveButton: 'שמור',
            validAudioFile: 'אנא בחר קובץ שמע תקין.',
            soundUploadedSuccess: 'הקובץ הועלה בהצלחה. ההשמעה תוגבל ל-15 שניות.',
            noAlertsSelectedForDeletion: 'לא נבחרו התראות למחיקה.',
            errorFetchingAlerts: 'שגיאה: לא ניתן לאחזר התראות.',
            networkIssuesOrApiRestrictions: 'ייתכן שזה נובע מבעיות רשת או הגבלות API.',
            rockets: 'ירי רקטות וטילים',
            earthquake: 'רעידת אדמה',
            infiltration: 'חדירת מחבלים',
            aircraft_intrusion: 'חדירת כלי טיס עוין',
            hazardous_materials: 'חומרים מסוכנים',
            tsunami: 'צונאמי',
        },
        ru: {
            appTitle: 'Израиль: оповещения в реальном времени',
            appSubtitle: 'Мониторинг угроз в реальном времени',
            settingsButton: 'Настройки',
            threatLegendTitle: 'Легенда угроз',
            testAlertButton: 'Тестовое оповещение',
            listManagementTitle: 'Управление списком',
            deleteSelectedButton: 'Удалить выбранное',
            clearAllButton: 'Очистить все',
            noAlertsMessage: 'Оповещений пока нет. Ожидание данных...',
            dataSourceDisclaimer: 'Данные получены от Командования тыла. Это не является официальной государственной службой.',
            settingsModalTitle: 'Настройки',
            languageTitle: 'Язык',
            areasOfInterestTitle: 'Области интересов',
            allAreasSelected: 'Все области выбраны',
            noAreasSelected: 'Области не выбраны',
            areasSelected: 'Выбрано {count} областей',
            searchAreasPlaceholder: 'Поиск областей...',
            alertSoundsTitle: 'Звуки оповещений',
            alarm1: 'Сигнал 1',
            alarm2: 'Сигнал 2',
            alarm3: 'Сигнал 3',
            custom: 'Пользовательский',
            uploadButton: 'Загрузить',
            themeTitle: 'Тема',
            darkModeLabel: 'Темный режим',
            saveButton: 'Сохранить',
            validAudioFile: 'Пожалуйста, выберите действительный аудиофайл.',
            soundUploadedSuccess: 'Звук успешно загружен. Воспроизведение будет ограничено 15 секундами.',
            noAlertsSelectedForDeletion: 'Не выбраны оповещения для удаления.',
            errorFetchingAlerts: 'Ошибка: Не удалось получить оповещения.',
            networkIssuesOrApiRestrictions: 'Возможно, это связано с проблемами сети или ограничениями API.',
            rockets: 'Ракетный обстрел',
            earthquake: 'Землетрясение',
            infiltration: 'Проникновение террористов',
            aircraft_intrusion: 'Вторжение вражеского самолета',
            hazardous_materials: 'Опасные материалы',
            tsunami: 'Цунами',
        }
    };

    let currentLanguage = localStorage.getItem('language') || 'en';

    // Function to apply translations
    function applyTranslations() {
        const lang = currentLanguage;

        // Update elements with data-i18n attribute
        document.querySelectorAll('[data-i18n]').forEach(element => {
            const key = element.getAttribute('data-i18n');
            if (translations[lang] && translations[lang][key]) {
                element.textContent = translations[lang][key];
            }
        });

        // Update placeholders
        document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
            const key = element.getAttribute('data-i18n-placeholder');
            if (translations[lang] && translations[lang][key]) {
                element.placeholder = translations[lang][key];
            }
        });

        // Update dynamic threatLabels
        threatLabels = {
            rockets: translations[lang].rockets,
            earthquake: translations[lang].earthquake,
            infiltration: translations[lang].infiltration,
            aircraft_intrusion: translations[lang].aircraft_intrusion,
            hazardous_materials: translations[lang].hazardous_materials,
            tsunami: translations[lang].tsunami,
        };
        populateLegend(); // Re-render legend with new labels

        // Update sound select options
        document.querySelectorAll('.sound-select').forEach(select => {
            Array.from(select.options).forEach(option => {
                if (option.value === 'sound1') option.textContent = translations[lang].alarm1;
                if (option.value === 'sound2') option.textContent = translations[lang].alarm2;
                if (option.value === 'sound3') option.textContent = translations[lang].alarm3;
                // If custom option already exists, ensure its text is updated
                if (option.value === 'custom') option.textContent = translations[lang].custom;
            });
        });

        // Update area selection summary
        updateAreaSelectionSummary();
        renderAlertList(); // Re-render alert list to update threat types
    }

    // Function to update area selection summary with translation
    function updateAreaSelectionSummary() {
        const summarySpan = document.getElementById('area-select-summary');
        const sortedCities = Object.keys(cityData).sort(); // Ensure sortedCities is available
        if (selectedAreas.length === sortedCities.length) {
            summarySpan.textContent = translations[currentLanguage].allAreasSelected;
        } else if (selectedAreas.length === 0) {
            summarySpan.textContent = translations[currentLanguage].noAreasSelected;
        } else {
            summarySpan.textContent = translations[currentLanguage].areasSelected.replace('{count}', selectedAreas.length);
        }
    }


    // Function to stop all playing preview sounds and reset UI
    function stopAllPreviews() {
        document.querySelectorAll('.play-sound-btn').forEach(b => {
            b.dataset.playing = 'false';
            b.querySelector('.play-icon').classList.remove('hidden');
            b.querySelector('.stop-icon').classList.add('hidden');
        });
        if (!audioPlayer.paused) {
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
        }
        // Clear any active trimming timeout
        if (customSoundTimeoutId) {
            clearTimeout(customSoundTimeoutId);
            customSoundTimeoutId = null;
        }
    }

    // --- MODAL & SIDEBAR HANDLING ---
    const settingsModal = document.getElementById('settings-modal');
    const sidebar = document.getElementById('sidebar');
    const menuButton = document.getElementById('menu-button');
    const mapOverlay = document.getElementById('map-overlay');

    function toggleSidebar() {
        sidebar.classList.toggle('-translate-x-full');
        mapOverlay.classList.toggle('hidden');
    }

    menuButton.addEventListener('click', toggleSidebar);
    mapOverlay.addEventListener('click', toggleSidebar);
    
    document.getElementById('settings-button').onclick = () => settingsModal.style.display = 'block';
    document.getElementById('close-settings').onclick = () => {
        settingsModal.style.display = 'none';
        stopAllPreviews(); // Stop preview sound on close
    };
    window.onclick = (event) => {
        if (event.target == settingsModal) {
            settingsModal.style.display = 'none';
            stopAllPreviews(); // Stop preview sound on close
        }
    };

    // --- THEME HANDLING ---
    const themeToggle = document.getElementById('theme-toggle');

    function setTheme(theme, updateToggle = false) {
        console.log("Setting theme to:", theme); // Debugging log
        if (theme === 'dark') {
            document.documentElement.classList.add('dark');
            if(updateToggle) themeToggle.checked = true;
            if (currentMapLayer) map.removeLayer(currentMapLayer);
            currentMapLayer = L.tileLayer(darkMapUrl, { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>' }).addTo(map);
        } else {
            document.documentElement.classList.remove('dark');
            if(updateToggle) themeToggle.checked = false;
            if (currentMapLayer) map.removeLayer(currentMapLayer);
            currentMapLayer = L.tileLayer(lightMapUrl, { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors' }).addTo(map);
        }
        setTimeout(() => map.invalidateSize(), 100);
    }

    // --- SETTINGS & TEST ---
    function populateAreaSelection() {
        const sortedCities = Object.keys(cityData).sort();
        selectedAreas = [...sortedCities]; // Select all by default
        
        const areaListContainer = document.getElementById('area-list-dropdown');
        const areaSearch = document.getElementById('area-search');
        const areaSelectButton = document.getElementById('area-select-button');
        const areaDropdown = document.getElementById('area-dropdown');
        // const summarySpan = document.getElementById('area-select-summary'); // Now handled by updateAreaSelectionSummary

        const renderList = (filter = '') => {
            areaListContainer.innerHTML = '';
            sortedCities
                .filter(city => city.toLowerCase().includes(filter.toLowerCase()))
                .forEach(city => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center p-1';
                    div.innerHTML = `<label class="w-full flex items-center"><input type="checkbox" class="area-checkbox mr-2" value="${city}" ${selectedAreas.includes(city) ? 'checked' : ''}> ${city}</label>`;
                    areaListContainer.appendChild(div);
                });
        };

        areaDropdown.addEventListener('change', (e) => {
            if (e.target.classList.contains('area-checkbox')) {
                const city = e.target.value;
                if (e.target.checked) {
                    if (!selectedAreas.includes(city)) selectedAreas.push(city);
                } else {
                    selectedAreas = selectedAreas.filter(c => c !== city);
                }
                updateAreaSelectionSummary(); // Call the updated summary function
            }
        });

        areaSearch.addEventListener('input', () => renderList(areaSearch.value));
        
        areaSelectButton.addEventListener('click', () => {
            areaDropdown.classList.toggle('hidden');
            if(!areaDropdown.classList.contains('hidden')) {
                renderList();
                areaSearch.focus();
            }
        });

        document.addEventListener('click', (e) => {
            if (!document.getElementById('area-selection-container').contains(e.target)) {
                areaDropdown.classList.add('hidden');
            }
        });

        updateAreaSelectionSummary(); // Initial call
    }

    function populateSoundSettings() {
        const container = document.getElementById('sound-settings-container');
        container.innerHTML = '';
        // Use a consistent order for threat types
        const orderedThreatTypes = ['rockets', 'earthquake', 'infiltration', 'aircraft_intrusion', 'hazardous_materials', 'tsunami'];

        orderedThreatTypes.forEach(threat => {
            const labelText = threatLabels[threat]; // Get translated label
            const div = document.createElement('div');
            div.className = 'flex items-center justify-between';
            div.innerHTML = `
                <label for="${threat}-sound">${labelText}:</label>
                <div class="flex items-center space-x-2">
                    <select id="${threat}-sound" class="sound-select border rounded-md p-1 bg-white dark:bg-gray-700 dark:text-gray-200" data-threat="${threat}">
                        <option value="sound1" data-i18n="alarm1">${translations[currentLanguage].alarm1}</option>
                        <option value="sound2" data-i18n="alarm2">${translations[currentLanguage].alarm2}</option>
                        <option value="sound3" data-i18n="alarm3">${translations[currentLanguage].alarm3}</option>
                        ${customSounds[threat] ? `<option value="custom" data-i18n="custom">${translations[currentLanguage].custom}</option>` : ''}
                    </select>
                    <button class="play-sound-btn p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600" data-threat="${threat}" data-playing="false">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 play-icon" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                        </svg>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 stop-icon hidden" viewBox="0 0 20 20" fill="currentColor">
                           <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 8a2 2 0 012-2h0a2 2 0 012 2v4a2 2 0 01-2 2h0a2 2 0 01-2-2V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <label class="cursor-pointer text-sm px-2 py-1 rounded-md transition-colors upload-button" for="upload-${threat}-sound">
                        Upload
                        <input type="file" id="upload-${threat}-sound" class="hidden custom-sound-upload" accept="audio/*" data-threat="${threat}">
                    </label>
                </div>
            `;
            container.appendChild(div);

            // Set the saved sound preference
            const selectElement = document.getElementById(`${threat}-sound`);
            if (alertSounds[threat]) {
                selectElement.value = alertSounds[threat];
            }
        });

        container.addEventListener('click', (e) => {
            const button = e.target.closest('.play-sound-btn');
            if (button) {
                const threat = button.dataset.threat;
                const select = document.getElementById(`${threat}-sound`);
                const soundKey = select.value;
                
                if (button.dataset.playing === 'true') {
                    stopAllPreviews();
                } else {
                    stopAllPreviews(); // Stop any other playing previews
                    button.dataset.playing = 'true';
                    button.querySelector('.play-icon').classList.remove('hidden');
                    button.querySelector('.stop-icon').classList.add('hidden');
                    playSound(threat, soundKey); // Pass soundKey directly for preview
                    audioPlayer.onended = () => {
                         button.dataset.playing = 'false';
                         button.querySelector('.play-icon').classList.remove('hidden');
                         button.querySelector('.stop-icon').classList.add('hidden');
                         if (customSoundTimeoutId) { // Clear timeout if sound ends naturally
                             clearTimeout(customSoundTimeoutId);
                             customSoundTimeoutId = null;
                         }
                    };
                }
            }
        });

        container.addEventListener('change', (e) => {
            if (e.target.classList.contains('custom-sound-upload')) {
                console.log("Upload button clicked and file selected.");
                const file = e.target.files[0];
                const threat = e.target.dataset.threat;

                if (file && file.type.startsWith('audio/')) {
                    console.log(`Attempting to read file: ${file.name}, type: ${file.type}`);
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        console.log("FileReader onload event fired. Result length:", event.target.result.length);
                        try {
                            customSounds[threat] = event.target.result; // Store the Base64 data
                            console.log(`Custom sound for ${threat} stored. Value starts with: ${customSounds[threat].substring(0, 30)}...`);
                            
                            const select = document.getElementById(`${threat}-sound`);
                            // Add 'custom' option if it doesn't exist
                            if (!Array.from(select.options).some(option => option.value === 'custom')) {
                                const customOption = new Option(translations[currentLanguage].custom, 'custom');
                                select.add(customOption);
                                console.log("Added 'custom' option to dropdown.");
                            }
                            select.value = 'custom'; // Select the 'custom' option
                            console.log(`Dropdown for ${threat} set to 'custom'.`);

                            // Show success modal
                            const modalDiv = document.createElement('div');
                            modalDiv.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-[2001] flex justify-center items-center';
                            modalDiv.innerHTML = `
                                <div class="bg-white p-6 rounded-lg shadow-xl text-center">
                                    <p class="text-lg font-semibold mb-4">${translations[currentLanguage].soundUploadedSuccess}</p>
                                    <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" onclick="this.closest('.fixed').remove()">OK</button>
                                </div>
                            `;
                            document.body.appendChild(modalDiv);
                            console.log("Success modal displayed.");
                        } catch (innerError) {
                            console.error("Error processing loaded file (inner try-catch):", innerError);
                            const modalDiv = document.createElement('div');
                            modalDiv.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-[2001] flex justify-center items-center';
                            modalDiv.innerHTML = `
                                <div class="bg-white p-6 rounded-lg shadow-xl text-center">
                                    <p class="text-lg font-semibold mb-4">An error occurred after loading the file. Please try again.</p>
                                    <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" onclick="this.closest('.fixed').remove()">OK</button>
                                </div>
                            `;
                            document.body.appendChild(modalDiv);
                            e.target.value = ''; // Clear the file input
                        }
                    };
                    reader.onerror = (error) => {
                        console.error("FileReader error:", error);
                        const modalDiv = document.createElement('div');
                        modalDiv.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-[2001] flex justify-center items-center';
                        modalDiv.innerHTML = `
                            <div class="bg-white p-6 rounded-lg shadow-xl text-center">
                                <p class="text-lg font-semibold mb-4">${translations[currentLanguage].validAudioFile}</p>
                                <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" onclick="this.closest('.fixed').remove()">OK</button>
                            </div>
                        `;
                        document.body.appendChild(modalDiv);
                        e.target.value = ''; // Clear the file input
                        console.log("Error modal displayed.");
                    };
                    reader.readAsDataURL(file); // Start reading the file as Base64
                } else {
                    console.log("Invalid file type selected.");
                    const modalDiv = document.createElement('div');
                    modalDiv.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-[2001] flex justify-center items-center';
                    modalDiv.innerHTML = `
                        <div class="bg-white p-6 rounded-lg shadow-xl text-center">
                            <p class="text-lg font-semibold mb-4">${translations[currentLanguage].validAudioFile}</p>
                            <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" onclick="this.closest('.fixed').remove()">OK</button>
                        </div>
                    `;
                    document.body.appendChild(modalDiv);
                }
            }
        });
    }
    
    function populateLegend() {
        const legendContainer = document.getElementById('threat-legend');
        legendContainer.innerHTML = ''; // Clear existing legend
        // Use the dynamic threatLabels for legend
        Object.keys(threatLabels).forEach(threat => {
            const color = threatColors[threat];
            const label = threatLabels[threat];
            const legendItem = document.createElement('div');
            legendItem.className = 'flex items-center';
            legendItem.innerHTML = `<span class="w-4 h-4 mr-2 rounded" style="background-color: ${color}; border: 1px solid #ccc;"></span> ${label}`;
            legendContainer.appendChild(legendItem);
        });
    }

    document.getElementById('save-settings').onclick = () => {
        // Save sounds
        document.querySelectorAll('.sound-select').forEach(select => {
            alertSounds[select.dataset.threat] = select.value;
        });

        // Save language
        const selectedLanguage = document.getElementById('language-select').value;
        localStorage.setItem('language', selectedLanguage);
        currentLanguage = selectedLanguage; // Update current language
        applyTranslations(); // Apply new language immediately

        // Save theme
        const newTheme = document.getElementById('theme-toggle').checked ? 'dark' : 'light';
        setTheme(newTheme);
        localStorage.setItem('theme', newTheme);
        
        stopAllPreviews(); // Stop preview sound on save
        // Close modal
        settingsModal.style.display = 'none';
    };
    
    document.getElementById('test-alert-button').onclick = () => {
        const allCities = Object.keys(cityData);
        const randomCity = allCities[Math.floor(Math.random() * allCities.length)];
        const testCities = [randomCity]; 

        const randomThreatType = Object.keys(threatLabels)[Math.floor(Math.random() * Object.keys(threatLabels).length)];
        // Use translated threat label for test alert title
        const testTitle = `--- ${translations[currentLanguage].testAlertButton}: ${threatLabels[randomThreatType]} ---`;

        handleIncomingAlerts(testCities, testTitle, true);
    };

    // --- CORE LOGIC ---
    function getThreatType(description) {
        const lowerDesc = description.toLowerCase();
        // Handle test alerts first
        if (lowerDesc.includes('test:')) {
            for (const [key, value] of Object.entries(translations[currentLanguage])) { // Check against translated labels
                if (lowerDesc.includes(value.toLowerCase())) return key;
            }
        }
        // Handle real alerts (using English keys for matching, as API is likely English-based)
        if (lowerDesc.includes('rocket') || lowerDesc.includes('missile') || lowerDesc.includes('רקטות') || lowerDesc.includes('טילים')) return 'rockets';
        if (lowerDesc.includes('earthquake') || lowerDesc.includes('רעידת אדמה')) return 'earthquake';
        if (lowerDesc.includes('terrorist') || lowerDesc.includes('מחבלים')) return 'infiltration';
        if (lowerDesc.includes('aircraft') || lowerDesc.includes('כלי טיס')) return 'aircraft_intrusion';
        if (lowerDesc.includes('hazardous') || lowerDesc.includes('חומרים מסוכנים')) return 'hazardous_materials';
        if (lowerDesc.includes('tsunami') || lowerDesc.includes('צונאמי')) return 'tsunami';
        return 'default';
    }

    async function fetchAlerts() {
        try {
            const proxyUrl = 'https://cors.bridged.cc/';
            const apiUrl = 'https://www.oref.org.il/WarningMessages/alert/alerts.json';
            const response = await fetch(`${proxyUrl}${apiUrl}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            const responseText = await response.text();
            if (responseText.trim() === '' || responseText.startsWith('<')) {
                return;
            }

            let data;
            try { data = JSON.parse(responseText); } 
            catch (e) { 
                console.error("Error parsing JSON:", e);
                return;
            }

            if (data && data.data && data.data.length > 0) {
                const filteredAlerts = filterAlerts(data.data);
                handleIncomingAlerts(filteredAlerts, data.title);
            }
        } catch (error) {
            console.error("Error fetching alerts:", error);
            const errorElement = document.createElement('div');
            // Clear any existing error messages before adding a new one
            const existingError = document.querySelector('.error-message-container');
            if (existingError) {
                existingError.remove();
            }
            errorElement.className = 'p-4 rounded-lg error-message-container';
            errorElement.innerHTML = `<p><strong>${translations[currentLanguage].errorFetchingAlerts}</strong></p><p class="text-sm">${translations[currentLanguage].networkIssuesOrApiRestrictions}</p></div>`;
            alertList.prepend(errorElement);
        }
    }

    function filterAlerts(alerts) {
        if (selectedAreas.length === 0) {
            return alerts; // If no areas are selected, show all
        }
        return alerts.filter(alertCity => {
            const normalizedCity = alertCity.split(' - ')[0].trim();
            return selectedAreas.includes(normalizedCity);
        });
    }
    
    function renderAlertList() {
        alertList.innerHTML = '';
        if (alertLog.length === 0) {
            alertList.innerHTML = `<div class="text-center text-gray-500 py-8"><p>${translations[currentLanguage].noAlertsMessage}</p></div>`;
            return;
        }

        alertLog.forEach((alertData, index) => {
            const threatType = alertData.threatType;
            const alertElement = document.createElement('div');
            // Applying the new class for consistent styling
            alertElement.className = 'p-3 rounded-md flex items-center alert-list-item';
            alertElement.innerHTML = `
                <input type="checkbox" class="history-item-checkbox mr-3 flex-shrink-0" data-index="${index}">
                <div class="flex-grow">
                    <p class="font-semibold">${alertData.city}</p>
                    <p class="text-sm" style="color: ${threatColors[threatType] || threatColors.default};">${threatLabels[threatType]}</p> <p class="text-xs text-gray-500 dark:text-gray-400">${alertData.time.toLocaleString(currentLanguage)}</p>
                </div>
            `;
            alertList.appendChild(alertElement);
        });
    }

    function handleIncomingAlerts(alerts, threatTitle, isTest = false) {
        let soundPlayed = false;
        
        alerts.forEach(alertCity => {
            const normalizedCity = alertCity.split(' - ')[0].trim();
            const threatType = getThreatType(threatTitle);
            
            const alertData = {
                city: alertCity,
                title: threatTitle,
                time: new Date(),
                threatType: threatType
            };
            alertLog.unshift(alertData);
            if (alertLog.length > 200) alertLog.pop();

            let lat, lon, bounds, shelterTime;
            if (cityData[normalizedCity]) {
                ({ lat, lon, bounds, time: shelterTime } = cityData[normalizedCity]);
            } else {
                lat = 31.0 + Math.random() * 2.0;
                lon = 34.5 + Math.random() * 1.0;
                bounds = null;
                shelterTime = 90; // Default time
            }
            
            if (!soundPlayed) {
                // For both real and test alerts, we want to play the sound configured in alertSounds for the given threatType.
                // The `soundKey` parameter in playSound is primarily for the settings modal's preview buttons.
                playSound(threatType); // No second argument needed here, it will use alertSounds[threatType]
                soundPlayed = true;
            }

            let areaLayer;
            const color = threatColors[threatType] || threatColors.default;

            if (bounds) {
                areaLayer = L.polygon(bounds, { color: color, weight: 3, fillColor: color, fillOpacity: 0.3 });
            } else {
                areaLayer = L.circle([lat, lon], { radius: 2500, color: color, weight: 2, fillColor: color, fillOpacity: 0.3 });
            }
            areaLayer.addTo(map).bindPopup(`<b>${alertCity}</b><br>${threatLabels[threatType]}`); // Use translated threat label in popup
            
            const polygonId = `${normalizedCity}-${Date.now()}`;
            activePolygons[polygonId] = areaLayer;

            setTimeout(() => {
                if (map.hasLayer(areaLayer)) map.removeLayer(areaLayer);
                delete activePolygons[polygonId];
                
                if (Object.keys(activePolygons).length === 0) {
                    map.setView([31.5, 34.75], 8);
                }
            }, shelterTime * 1000);
        });
        
        renderAlertList();
        
        const allActiveLayers = Object.values(activePolygons);
        if (allActiveLayers.length > 0) {
            const group = new L.featureGroup(allActiveLayers);
            map.fitBounds(group.getBounds(), { padding: [50, 50] });
        }
    }

    function playSound(threatType, soundKey = null) { // Made soundKey optional
        // Clear any previous trimming timeout before playing a new sound
        if (customSoundTimeoutId) {
            clearTimeout(customSoundTimeoutId);
            customSoundTimeoutId = null;
        }

        const effectiveSoundKey = soundKey || alertSounds[threatType];
        let soundFile;

        if (effectiveSoundKey === 'custom' && customSounds[threatType]) {
            soundFile = customSounds[threatType];
            // Set a timeout to stop playback after 15 seconds for custom sounds
            customSoundTimeoutId = setTimeout(() => {
                if (!audioPlayer.paused) {
                    audioPlayer.pause();
                    audioPlayer.currentTime = 0;
                    // Find the relevant play/stop button and reset its UI
                    const playingButton = document.querySelector(`.play-sound-btn[data-threat="${threatType}"][data-playing="true"]`);
                    if (playingButton) {
                        playingButton.dataset.playing = 'false';
                        playingButton.querySelector('.play-icon').classList.remove('hidden');
                        playingButton.querySelector('.stop-icon').classList.add('hidden');
                    }
                }
            }, 15000); // 15 seconds
        } else if (soundFiles[effectiveSoundKey]) {
            soundFile = soundFiles[effectiveSoundKey];
        } else {
            // Fallback to a default sound if the configured soundKey is not found or invalid
            soundFile = soundFiles['sound1']; 
        }
        
        if (soundFile) {
            audioPlayer.src = soundFile;
            audioPlayer.play().catch(e => console.error("Error playing sound:", e));
        }
    }

    // --- HISTORY FUNCTIONS ---
    document.getElementById('clear-all-alerts').addEventListener('click', () => {
        alertLog = [];
        renderAlertList();
    });

    document.getElementById('delete-selected-alerts').addEventListener('click', () => {
        const indicesToDelete = Array.from(document.querySelectorAll('#alert-list .history-item-checkbox:checked'))
                                     .map(cb => parseInt(cb.dataset.index, 10));

        if (indicesToDelete.length === 0) {
            // Using a custom modal instead of alert()
            const modalDiv = document.createElement('div');
            modalDiv.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-[2001] flex justify-center items-center';
            modalDiv.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl text-center">
                    <p class="text-lg font-semibold mb-4">${translations[currentLanguage].noAlertsSelectedForDeletion}</p>
                    <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" onclick="this.closest('.fixed').remove()">OK</button>
                </div>
            `;
            document.body.appendChild(modalDiv);
            return;
        }

        alertLog = alertLog.filter((_, index) => !indicesToDelete.includes(index));
        renderAlertList();
    });


    // --- STARTUP ---
    // Get language from localStorage on startup
    const savedLanguage = localStorage.getItem('language');
    if (savedLanguage && translations[savedLanguage]) {
        currentLanguage = savedLanguage;
    } else {
        currentLanguage = 'en'; // Default to English
    }

    // Set the language select in the modal to the current language
    document.addEventListener('DOMContentLoaded', () => {
        const languageSelect = document.getElementById('language-select');
        if (languageSelect) {
            languageSelect.value = currentLanguage;
        }
        applyTranslations(); // Apply translations on initial load
        populateAreaSelection(); // Ensure this runs after translations for proper summary
        populateSoundSettings(); // Ensure this runs after translations for proper labels
    });
    
    // Set initial theme
    const preferredTheme = localStorage.getItem('theme') || 'light';
    setTheme(preferredTheme, true); // Update the toggle to match

    fetchAlerts();
    setInterval(fetchAlerts, 15000);

</script>

</body>
</html>
